#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

const int P_MEMORY_SIZE_BYTES = 10;
const int P_VALUE_ADDITION = 4;

void example1() {
    printf("[+] Allocating 3 pointers\n");
    int* p1 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    int* p2 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    int* p3 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    printf("[*] p1: %p, p2: %p, p3: %p\n", p1, p2, p3);

    printf("[-] Freeing all 3 pointers\n");
    free(p1);
    free(p2);
    free(p3);

    int counter = 1;
    uint64_t* current_p = (uint64_t*) p3;
    while (current_p != NULL) {
        printf("[*] %dth pointer to be allocated: %p", counter, current_p);
        current_p = (uint64_t*)(*current_p);
        counter++;
    }

    printf("[+] Allocating 3 pointers\n");
    p1 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    p2 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    p3 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    printf("[*] p1: %p, p2: %p, p3: %p\n", p1, p2, p3);
}

void example2() {
    printf("[+] Allocating 2 pointers\n");
    int* p1 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    int* p2 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    printf("[*] p1: %p, p2: %p\n", p1, p2);

    printf("[-] Freeing all 2 pointers\n");
    free(p1);
    free(p2);

    int counter = 1;
    uint64_t* current_p = (uint64_t*) p2;
    while (current_p != NULL) {
        uint64_t* next_p = (uint64_t*)(*current_p);
        printf("[*] %dth pointer to be allocated: %p -> %p\n", counter, current_p, next_p);
        current_p = next_p;
        counter++;
    }

    current_p = (uint64_t*) p2;
    uint64_t replacement_p_value = (uint64_t)(p1 + P_VALUE_ADDITION);
    *current_p = replacement_p_value;
    printf("[*] Replaced value at %p to %p\n", current_p, (int *)replacement_p_value);

    counter = 1;
    current_p = (uint64_t*) p2;
     while (current_p != NULL) {
        uint64_t* next_p = (uint64_t*)(*current_p);
        printf("[*] %dth pointer to be allocated: %p -> %p\n", counter, current_p, next_p);
        current_p = next_p;
        counter++;
    }

    printf("[+] Allocating 2 pointers\n");
    int* p1 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    int* p2 = (int*) malloc(P_MEMORY_SIZE_BYTES);
    printf("[*] p1: %p, p2: %p\n", p1, p2);

}

int main() {
    example1();
    example2();
}